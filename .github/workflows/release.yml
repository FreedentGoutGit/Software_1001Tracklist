name: Release

on:
  push:
    branches:
      - main

jobs:
  test-and-build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 yt-dlp customtkinter pyinstaller

    - name: Test libraries
      run: python -c "import tkinter; import customtkinter; import requests; import bs4; import yt_dlp; print('Libraries installed successfully')"

    - name: Test 1001 Tracklists scraping
      run: |
        python -c "
        from scrapper_bot import scrape_tracklist
        tracks = scrape_tracklist('https://www.1001tracklists.com/tracklist/2tzn3tuk/deepack-memorylane-klokgebouw-eindhoven-netherlands-2025-12-20.html')
        if len(tracks) > 0:
            print('1001 Tracklists test passed')
        else:
            exit(1)
        "

    - name: Test YouTube playlist extraction
      run: |
        python -c "
        from scrapper_bot import get_youtube_playlist_tracks
        tracks = get_youtube_playlist_tracks('https://www.youtube.com/playlist?list=PLI1v0B_8oarTtujvKv7nkmfpVc7yE4By2')
        if len(tracks) > 0:
            print('YouTube playlist test passed')
        else:
            exit(1)
        "

    - name: Build executable
      run: pyinstaller --onefile --windowed scrapper_bot.py

    - name: Create Release
      uses: actions/create-release@v1
      id: create_release
      with:
        tag_name: v${{ github.run_number }}
        release_name: Release v${{ github.run_number }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/scrapper_bot.exe
        asset_name: PlaylistDownloader.exe
        asset_content_type: application/octet-stream
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}